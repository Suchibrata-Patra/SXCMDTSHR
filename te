<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Preview Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #007AFF;
            background: #f0f8ff;
        }
        .result {
            margin-top: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        .error {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success {
            background: #efe;
            color: #060;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background: #007AFF;
            color: white;
        }
        .log {
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log div {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>CSV Preview Test</h1>
    <p>This test page will help debug the CSV preview functionality.</p>

    <div class="upload-area" onclick="document.getElementById('csvInput').click()">
        <h3>üì§ Click to Upload CSV File</h3>
        <p>Or drag and drop a CSV file here</p>
    </div>
    <input type="file" id="csvInput" accept=".csv" style="display: none;" onchange="handleFile(this.files[0])">

    <div id="result"></div>
    <div id="log" class="log"></div>

    <script>
        const resultDiv = document.getElementById('result');
        const logDiv = document.getElementById('log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#c00' : type === 'success' ? '#060' : '#000';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        async function handleFile(file) {
            if (!file) {
                log('No file selected', 'error');
                return;
            }

            log(`File selected: ${file.name} (${file.size} bytes, type: ${file.type})`);

            if (!file.name.endsWith('.csv')) {
                log('Warning: File does not have .csv extension', 'error');
            }

            resultDiv.innerHTML = '<div class="result">Loading preview...</div>';

            const formData = new FormData();
            formData.append('csv_file', file);

            log('Sending request to process_bulk_mail.php?action=preview');

            try {
                const response = await fetch('process_bulk_mail.php?action=preview', {
                    method: 'POST',
                    body: formData
                });

                log(`Response status: ${response.status} ${response.statusText}`);

                const contentType = response.headers.get('content-type');
                log(`Content-Type: ${contentType}`);

                const text = await response.text();
                log(`Response length: ${text.length} characters`);
                log(`First 200 chars: ${text.substring(0, 200)}`);

                let result;
                try {
                    result = JSON.parse(text);
                    log('JSON parsed successfully', 'success');
                } catch (e) {
                    log('JSON parse error: ' + e.message, 'error');
                    resultDiv.innerHTML = `<div class="error">
                        <h3>‚ùå Invalid JSON Response</h3>
                        <p>The server returned invalid JSON. This could be a PHP error.</p>
                        <pre style="background: #fff; padding: 10px; overflow-x: auto;">${escapeHtml(text)}</pre>
                    </div>`;
                    return;
                }

                if (result.success) {
                    log(`Preview successful! ${result.total_rows} total rows`, 'success');
                    displayPreview(result);
                } else {
                    log('Preview failed: ' + result.error, 'error');
                    resultDiv.innerHTML = `<div class="error">
                        <h3>‚ùå Preview Failed</h3>
                        <p>${escapeHtml(result.error)}</p>
                        ${result.debug_info ? `<pre>${JSON.stringify(result.debug_info, null, 2)}</pre>` : ''}
                    </div>`;
                }
            } catch (error) {
                log('Fetch error: ' + error.message, 'error');
                resultDiv.innerHTML = `<div class="error">
                    <h3>‚ùå Request Failed</h3>
                    <p>${escapeHtml(error.message)}</p>
                    <p>Check browser console for more details.</p>
                </div>`;
            }
        }

        function displayPreview(result) {
            let html = `<div class="success">
                <h3>‚úÖ Preview Loaded Successfully</h3>
                <p>${result.message}</p>
                <p><strong>Total Rows:</strong> ${result.total_rows}</p>
                <p><strong>Preview Rows:</strong> ${result.preview_rows.length}</p>
            </div>`;

            html += '<table><thead><tr>';
            html += '<th>#</th><th>Email</th><th>Name</th><th>Subject</th><th>Article</th><th>Message</th>';
            html += '</tr></thead><tbody>';

            result.preview_rows.forEach(row => {
                html += `<tr>
                    <td>${row.row_number}</td>
                    <td>${escapeHtml(row.mail_id)}</td>
                    <td>${escapeHtml(row.receiver_name)}</td>
                    <td>${escapeHtml(row.subject)}</td>
                    <td>${escapeHtml(row.article_title)}</td>
                    <td>${escapeHtml(row.message_preview)}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            resultDiv.innerHTML = html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Drag and drop
        const uploadArea = document.querySelector('.upload-area');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#007AFF';
            uploadArea.style.background = '#f0f8ff';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#ccc';
            uploadArea.style.background = '';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ccc';
            uploadArea.style.background = '';
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });

        log('Test page loaded. Ready to upload CSV file.');
    </script>
</body>
</html>