<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Mailer System Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .test-section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        h2 {
            color: #4ec9b0;
            margin-top: 0;
        }

        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #1177bb;
        }

        .result {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }

        .success {
            color: #4ec9b0;
        }

        .error {
            color: #f48771;
        }

        .warning {
            color: #dcdcaa;
        }

        .info {
            color: #9cdcfe;
        }
    </style>
</head>

<body>
    <h1>ðŸ§ª Bulk Mailer System Test & Debug</h1>

    <div class="test-section">
        <h2>1. Session Check</h2>
        <button onclick="testSession()">Test Session</button>
        <div id="session-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. Database Connection</h2>
        <button onclick="testDatabase()">Test Database</button>
        <div id="database-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. Queue Status</h2>
        <button onclick="testQueueStatus()">Get Queue Status</button>
        <div id="queue-status-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>4. Queue List</h2>
        <button onclick="testQueueList()">Get Queue List</button>
        <div id="queue-list-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>5. Backend API</h2>
        <button onclick="testBackendFields()">Test Expected Fields</button>
        <div id="backend-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>6. File Upload Test</h2>
        <input type="file" id="testFile" accept=".csv">
        <button onclick="testFileUpload()">Upload & Analyze</button>
        <div id="upload-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>7. System Info</h2>
        <button onclick="getSystemInfo()">Get Info</button>
        <div id="system-info" class="result"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            element.innerHTML = `<span class="${className}">[${timestamp}] ${message}</span>`;
        }

        function logJson(elementId, data, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            element.innerHTML = `<span class="${className}">[${timestamp}] ${JSON.stringify(data, null, 2)}</span>`;
        }

        async function testSession() {
            log('session-result', 'Testing session...', 'info');

            try {
                const response = await fetch('process_bulk_mail.php?action=test');
                const text = await response.text();

                console.log('Session response text:', text);

                try {
                    const data = JSON.parse(text);

                    if (data.success) {
                        logJson('session-result', {
                            status: 'SUCCESS âœ“',
                            user_email: data.user_email,
                            user_id: data.user_id,
                            php_version: data.php_version,
                            session_active: data.session_active
                        }, 'success');
                    } else {
                        logJson('session-result', {
                            status: 'FAILED âœ—',
                            error: data.error
                        }, 'error');
                    }
                } catch (e) {
                    log('session-result', `Parse Error: ${e.message}\n\nRaw Response:\n${text}`, 'error');
                }
            } catch (error) {
                log('session-result', `Request Failed: ${error.message}`, 'error');
            }
        }

        async function testDatabase() {
            log('database-result', 'Testing database connection...', 'info');

            try {
                const response = await fetch('process_bulk_mail.php?action=test');
                const data = await response.json();

                if (data.success) {
                    logJson('database-result', {
                        status: 'DATABASE CONNECTED âœ“',
                        user_id: data.user_id,
                        message: 'Database connection working'
                    }, 'success');
                } else {
                    log('database-result', `Database Error: ${data.error}`, 'error');
                }
            } catch (error) {
                log('database-result', `Connection Failed: ${error.message}`, 'error');
            }
        }

        async function testQueueStatus() {
            log('queue-status-result', 'Fetching queue status...', 'info');

            try {
                const response = await fetch('process_bulk_mail.php?action=status');
                const text = await response.text();

                console.log('Queue status response:', text);

                try {
                    const data = JSON.parse(text);

                    if (data.success) {
                        logJson('queue-status-result', {
                            status: 'SUCCESS âœ“',
                            pending: data.pending || 0,
                            processing: data.processing || 0,
                            completed: data.completed || 0,
                            failed: data.failed || 0,
                            total: data.total || 0
                        }, 'success');
                    } else {
                        log('queue-status-result', `Error: ${data.error}`, 'error');
                    }
                } catch (e) {
                    log('queue-status-result', `Parse Error: ${e.message}\n\nRaw:\n${text}`, 'error');
                }
            } catch (error) {
                log('queue-status-result', `Request Failed: ${error.message}`, 'error');
            }
        }

        async function testQueueList() {
            log('queue-list-result', 'Fetching queue list...', 'info');

            try {
                const response = await fetch('process_bulk_mail.php?action=queue_list');
                const text = await response.text();

                console.log('Queue list response:', text);

                try {
                    const data = JSON.parse(text);

                    if (data.success) {
                        if (data.queue && data.queue.length > 0) {
                            logJson('queue-list-result', {
                                status: 'SUCCESS âœ“',
                                count: data.queue.length,
                                first_3_items: data.queue.slice(0, 3)
                            }, 'success');
                        } else {
                            log('queue-list-result', 'Queue is empty (this is normal if no emails added yet)', 'warning');
                        }
                    } else {
                        log('queue-list-result', `Error: ${data.error}`, 'error');
                    }
                } catch (e) {
                    log('queue-list-result', `Parse Error: ${e.message}\n\nRaw:\n${text.substring(0, 500)}`, 'error');
                }
            } catch (error) {
                log('queue-list-result', `Request Failed: ${error.message}`, 'error');
            }
        }

        async function testBackendFields() {
            log('backend-result', 'Testing backend API...', 'info');

            try {
                const response = await fetch('bulk_mail_backend.php?action=get_expected_fields');
                const text = await response.text();

                console.log('Backend response:', text);

                try {
                    const data = JSON.parse(text);

                    if (data.success) {
                        const fieldCount = Object.keys(data.expected_fields).length;
                        logJson('backend-result', {
                            status: 'BACKEND API WORKING âœ“',
                            field_count: fieldCount,
                            fields: Object.keys(data.expected_fields)
                        }, 'success');
                    } else {
                        log('backend-result', `Error: ${data.error}`, 'error');
                    }
                } catch (e) {
                    log('backend-result', `Parse Error: ${e.message}\n\nRaw:\n${text}`, 'error');
                }
            } catch (error) {
                log('backend-result', `Request Failed: ${error.message}`, 'error');
            }
        }

        async function testFileUpload() {
            const fileInput = document.getElementById('testFile');

            if (!fileInput.files.length) {
                log('upload-result', 'Please select a CSV file first', 'warning');
                return;
            }

            log('upload-result', 'Uploading and analyzing file...', 'info');

            const formData = new FormData();
            formData.append('csv_file', fileInput.files[0]);

            try {
                const response = await fetch('bulk_mail_backend.php?action=analyze', {
                    method: 'POST',
                    body: formData
                });

                const text = await response.text();
                console.log('Upload response:', text);

                try {
                    const data = JSON.parse(text);

                    if (data.success) {
                        logJson('upload-result', {
                            status: 'FILE ANALYZED âœ“',
                            filename: data.filename,
                            total_rows: data.total_rows,
                            columns: data.csv_columns,
                            auto_mapped: Object.keys(data.suggested_mapping || {}).length,
                            preview: data.preview_rows.slice(0, 2)
                        }, 'success');
                    } else {
                        log('upload-result', `Error: ${data.error}`, 'error');
                    }
                } catch (e) {
                    log('upload-result', `Parse Error: ${e.message}\n\nRaw:\n${text}`, 'error');
                }
            } catch (error) {
                log('upload-result', `Upload Failed: ${error.message}`, 'error');
            }
        }

        function getSystemInfo() {
            const info = {
                'Browser': navigator.userAgent,
                'Screen': `${screen.width}x${screen.height}`,
                'Location': window.location.href,
                'Protocol': window.location.protocol,
                'Host': window.location.host,
                'Current Time': new Date().toISOString()
            };

            logJson('system-info', info, 'info');
        }

        // Auto-run session test on load
        window.addEventListener('load', () => {
            testSession();
            testQueueStatus();
        });
    </script>
</body>

</html>